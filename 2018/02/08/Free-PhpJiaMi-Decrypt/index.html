<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 某PHP加密文件解密过程初探 · 浮萍's Blog</title><meta name="description" content="某PHP加密文件解密过程初探 - 浮萍"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fuping.site/atom.xml" title="浮萍's Blog"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="浮萍's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">所有文章</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/search" target="_self" class="nav-list-link search"><i class="fa fa-search" aria-hidden="true"></i></a></li></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">某PHP加密文件解密过程初探</h1><div class="post-info">Feb 8, 2018<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BE%8E/" class="post-category">#编程之美</a></div><div class="post-content"><p>最近在52PJ上看到一篇关于PHP加密解密的帖子，过程非常详细，而且作者很负责，对于别人的回答也很热心。跟着动手做了一下，记录一下遇到的问题。这里针对的是PHP加密网站的免费加密进行的调试。</p>
<a id="more"></a>
<h1 id="0x01-环境准备"><a href="#0x01-环境准备" class="headerlink" title="0x01 环境准备"></a>0x01 环境准备</h1><p>采用的IDE为VSCode，需要安装PHP DEBUG插件和XDebug 插件。<br>安装php debug插件比较简单，直接快捷键ctrl + shift + x  或者 “查看-扩展” 打开扩展面板。输入”php debug”搜索。<br><img src="01.jpg" alt="01"><br>然后安装即可。<br>其次是安装XDebug。安装可以参考:<a href="https://xdebug.org/docs/install" target="_blank" rel="noopener">https://xdebug.org/docs/install</a> 。首先查看一下PHP版本。我这里用的是5.5.30。<br><img src="02.jpg" alt="02"><br>打开php.ini，找到XDebug标签（我这里ext目录已经有xdebug.dll了，直接启用扩展即可）。如果没有XDebug标签，自己添加即可。<br><img src="03.jpg" alt="03"><br>打开扩展。<br><img src="04.png" alt="04"><br>注意设置<code>xdebug.remote_autostart = 1</code>。这样设置好debug和断点后，浏览器运行即可自动命中断点。<br>打开VSCode，设置编辑php的可执行文件路径。<br><img src="05.jpg" alt="05"><br>这样调试所需的环境就配置好了。使用时打开左侧的调试按钮，然后添加配置语言选择PHP。<br><img src="06.jpg" alt="06"><br>给代码添加断点后，点击开始调试按钮。浏览器访问时会在断点处停下，就可以进行调试了。<br><img src="07.jpg" alt="07"><br>乱码的话可以通过更改文件编码来设置。快捷键<code>Ctrl + Shift + P</code>，选择更改文件编码，找到合适的编码。<br><img src="08.jpg" alt="08"><br>php最大执行时间是30秒，超过30秒会自动终止，因此调试的时候要修改一下时间，在php.ini 文件中修改最大运行时间为5分钟。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_execution_time = <span class="number">300</span></span><br></pre></td></tr></table></figure>

<h1 id="0x02-解密"><a href="#0x02-解密" class="headerlink" title="0x02 解密"></a>0x02 解密</h1><h4 id="1-独立加密"><a href="#1-独立加密" class="headerlink" title="1.独立加密"></a>1.独立加密</h4><p>上面环境已经准备好了，下面就开始正式工作了。首先需要获得一个加密的文件。我直接利用上面的文件去某加密网站进行加密。<br><img src="09.jpg" alt="09"><br>加密后大概是这样的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="comment">/* PHP Encode by  http://Www.PHPJiaMi.Com/ */</span>error_reporting(<span class="number">0</span>);ini_set(<span class="string">"display_errors"</span>, <span class="number">0</span>);<span class="keyword">if</span>(!defined(<span class="string">'kcapwkef'</span>))&#123;define(<span class="string">'kcapwkef'</span>,<span class="keyword">__FILE__</span>);<span class="keyword">if</span>(!function_exists(<span class="string">"�㒁�؁��"</span>))&#123;<span class="function"><span class="keyword">function</span> �����ٹ�<span class="params">($������)</span></span>&#123;<span class="keyword">global</span>$Đ���Л�,$�……</span><br></pre></td></tr></table></figure>

<p>使用PHP-Parser对代码进行格式化，便于调试。<br>执行命令<code>composer require nikic/php-parser</code><br><img src="10.jpg" alt="10"><br>利用作者的format.php将代码格式化。代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Error</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">ParserFactory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">PrettyPrinter</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line">$code = file_get_contents(<span class="string">'9014/t.php'</span>);</span><br><span class="line">$parser = (<span class="keyword">new</span> ParserFactory)-&gt;create(ParserFactory::PREFER_PHP7);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $ast = $parser-&gt;parse($code);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Error $error) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Parse error: &#123;$error-&gt;getMessage()&#125;\n"</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">$prettyPrinter = <span class="keyword">new</span> PrettyPrinter\Standard;</span><br><span class="line">$prettyCode = $prettyPrinter-&gt;prettyPrintFile($ast);</span><br><span class="line">file_put_contents(<span class="string">'9014/t2.php'</span>, $prettyCode);</span><br></pre></td></tr></table></figure>

<p>然后执行命令<code>php format.php</code>，会生成格式化的t2.php。<br><img src="11.jpg" alt="11"><br>选择一个不是多字节的字符集，这样在调试的时候可以显示出变量代表的内容。这里用的是<code>Western (ISO 8859-1)</code>。<br>我的思路是在程序开始下断点，然后一直F10（单步跳过），当程序中断时，在此处下断点，F11进入（单步调试）。找到中断的原因，解决后再重复上述操作。<br>F10运行时发现在102行退出了程序。<br><img src="12.jpg" alt="12"><br>然后在第102行下断点，F11单步运行。进入后继续F10运行。<br><img src="13.jpg" alt="13"><br>当运行到第23行时，程序退出。前面两个变量是多字节字符，所以看不到内容，后面的是die。看代码可以看到前两个分别在第13行和第15行出现。再次运行，当运行到第13行时F11进入。调用了第52行的函数（由于函数名是乱码，我们给起个名字<code>decode_func</code>）。<br><img src="14.jpg" alt="14"><br>直接在73行返回值处下断点，然后F5运行，看返回的结果。<br><img src="15.jpg" alt="15"><br>同理，查看第15行返回的结果。<br><img src="16.jpg" alt="16"><br>那么第23行处的代码为：<br><code>php_sapi_name() == &#39;cli&#39; ? die() : &#39;&#39;;</code><br><img src="17.jpg" alt="17"><br>由于这里是在命令行下执行的，所以会退出。找到了问题所在，直接注释掉此处即可。然后重新执行。运行至第26行时再次退出。<br><img src="18.jpg" alt="18"><br>此处代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_HOST'</span>]) &amp;&amp; !<span class="keyword">isset</span>($_SERVER[<span class="string">'SERVER_ADDR'</span>]) &amp;&amp; !<span class="keyword">isset</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>])) &#123; </span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由控制台发现<br><code>!isset($_SERVER[&#39;HTTP_HOST&#39;]) &amp;&amp; !isset($_SERVER[&#39;SERVER_ADDR&#39;]) &amp;&amp; !isset($_SERVER[&#39;REMOTE_ADDR&#39;])</code><br>执行结果为true，所以会退出。还是屏蔽该if判断即可。重新执行。<br><img src="19.jpg" alt="19"><br>第28-32行对应代码。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$t = microtime(<span class="keyword">true</span>) * <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">""</span>);</span><br><span class="line"><span class="keyword">if</span> (microtime(<span class="keyword">true</span>) * <span class="number">1000</span> - $t &gt; <span class="number">100</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处判断执行时间大于100毫秒就退出，当然还是注释即可。<br>运行至第34行，程序退出。F11进入。调用了第52行的<code>decode_func</code>函数。<br><img src="20.jpg" alt="20"><br>直接查看返回值。<br><img src="21.jpg" alt="21"><br>第34行对应的代码为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!strpos(decode_func(substr($f, <span class="number">-45</span>, <span class="number">-1</span>)), md5(substr($f, <span class="number">0</span>, <span class="number">-46</span>))) ? $undefined1() : $undefined2;</span><br></pre></td></tr></table></figure>
<p><code>decode_func</code>是第52行的函数，$f是当前的文件，<code>$undefined1</code>和 <code>$undefined2</code>都不存在。查看<code>strpos</code>中两个参数。<br><img src="22.jpg" alt="22"><br>那么 <code>! strops(string,find)</code> 的结果为true。则执行<code>$undefined1()</code>，这个方法不存在，就会Error并退出程序。如下图所示。<br><img src="23.jpg" alt="23"><br>解决方法是注释第34行或者将”!”去掉。去掉”!”会执行 <code>$undefined2</code>，只会警告而不会退出。这里采用”暴力”的手段，直接注释掉了。<br>然后重新执行程序，F5运行到断点后，F11进入，然后F10运行。<br>运行到38行时，查看返回的内容，是源文件的内容。这个内容就是我们需要的。<br><img src="24.jpg" alt="24"><br>可以通过file_put_contents将文件保存即可。<br><img src="25.jpg" alt="25"><br>查看输出的结果。<br><img src="26.jpg" alt="26"><br>也可以在第102行用file_put_contents将文件保存。<br>使用原作者的decrypt.php也可解密。执行命令：<code>php decrypt.php 9014\t.php</code>，会生成解密后的文件”t.php.decrypted.php”。<br><img src="27.jpg" alt="27"></p>
<h4 id="2-LIB库加密"><a href="#2-LIB库加密" class="headerlink" title="2._LIB库加密"></a>2._LIB库加密</h4><p>调试过程和独立加密类似。<br><img src="28.jpg" alt="28"><br>还用之前的t.php作为源文件，加密后生成两个文件，一个是t.php，一个是_lib.php。<br><img src="29.jpg" alt="29"><br>这里的t.php就比较简单了，直接调用了_lib.php文件。主要研究的还是_lib.php文件。老规矩，还是先格式化。新建文件夹viptest，将t.php和格式化后的_lib.php复制进去。然后对格式化后的_lib.php进行编码转换。下断点开始进行调试。这里断点为106行。<br>然后浏览器访问，就会在断点处停止。F11进入后F10单步跳过。<br><img src="30.jpg" alt="30"><br>运行至第43行时退出，直接屏蔽这几行即可。然后重新访问。<br><img src="31.jpg" alt="31"><br>运行至第46行，校验数据完整性，由于_lib.php是格式化而来的代码，所以此处校验不通过，就会调用不存在的方法，然后产生错误而退出。<br>执行的代码为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$f = file_get_contents(<span class="string">'_lib.php'</span>);</span><br><span class="line">!strpos(decode_func(substr($f, <span class="number">-45</span>, <span class="number">-1</span>)), md5(substr($f, <span class="number">0</span>, <span class="number">-46</span>))) ? $undefined1() : $undefined2;</span><br></pre></td></tr></table></figure>
<p><img src="32.jpg" alt="32"><br>注释该校验即可。<br>继续执行，查看返回即可看到加密前的代码了。<br><img src="33.jpg" alt="33"></p>
<h1 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h1><p>类似此类的加密文件在进行调试时需要先将代码格式化，选择不是多字节的字符集，然后进行调试。我的测试流程是首先在开始下断点，然后F10执行，当遇到程序退出时，在此处下断点，再次运行，运行到此处F11进入。进入后F10执行，找到问题所在解决后重复上述流程。</p>
<p>这里都是以免费加密为例，关于VIP加密的可以参考作者的文章<a href="https://www.52pojie.cn/thread-693641-1-1.html" target="_blank" rel="noopener">【原创】某PHP加密文件调试解密过程</a> ，还有他的虚拟机加密解密的文章也值得学习。</p>
<p><a href="https://fuping.site/files/ctf.7z">所用的代码</a></p>
<h1 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h1><p><a href="https://www.52pojie.cn/thread-693641-1-1.html" target="_blank" rel="noopener">https://www.52pojie.cn/thread-693641-1-1.html</a></p>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/PHP%E8%A7%A3%E5%AF%86/">#PHP解密</a><a href="/tags/PHP%E8%B0%83%E8%AF%95/">#PHP调试</a></p></article></div><footer><div class="paginator"><a href="/2018/05/25/UEditor-SSRF-In-JSP/" class="prev">PREV</a><a href="/2018/01/31/Unity3d-Android-Game-Reverse-Analysis-Of-The-Tabikaeru/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2023 <a href="https://fuping.site">浮萍</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-103156844-1",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>