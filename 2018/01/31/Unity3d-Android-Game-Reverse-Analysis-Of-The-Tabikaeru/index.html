<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Unity3d类安卓游戏逆向分析初探 · 浮萍's Blog</title><meta name="description" content="Unity3d类安卓游戏逆向分析初探 - 浮萍"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fuping.site/atom.xml" title="浮萍's Blog"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="浮萍's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">所有文章</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/search" target="_self" class="nav-list-link search"><i class="fa fa-search" aria-hidden="true"></i></a></li></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">Unity3d类安卓游戏逆向分析初探</h1><div class="post-info">Jan 31, 2018<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/%E7%A7%BB%E5%8A%A8%E5%AE%89%E5%85%A8/" class="post-category">#移动安全</a></div><div class="post-content"><h3 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>最近一款养蛙的游戏非常火，但是语言是日文的。下载了一个汉化的，结果广告一大堆。反编译之后查看是Unity游戏，之前没接触过，就想着跟着看一下。关于这类的破解，可以在52pojie上进行搜索。有很多类似的案例。<br>这里主要采用的工具为dnSpy，dnSpy 是一款针对 .NET 程序的逆向工程工具。反编译和打包采用的是apktool，当然也可以直接用改之理等工具。</p>
<a id="more"></a>
<h3 id="0x02-修改数据"><a href="#0x02-修改数据" class="headerlink" title="0x02 修改数据"></a>0x02 修改数据</h3><p>下载app后重命名为zip文件，发现存在assets\bin\Data\Managed目录，那么该游戏应该为Unity游戏。<br><img src="1.jpg" alt="查看apk文件"><br>那么需要分析的文件就是就是Assembly-CSharp.dll。</p>
<p>首先修改一下抽奖券的数量。安装游戏后，找到抽奖的地方。抽奖的时候提示券不足。<br><img src="2.jpg" alt="抽奖券不足"></p>
<p>使用dnSpy打开Assembly-CSharp.dll文件，然后搜索字符串”足”，可以发现有两个，打开后发现是第一个。<br><img src="3.jpg" alt="搜索字符串"><br>由此可以猜测TicketStock代表抽奖券库存。<br><img src="4.jpg" alt="抽奖券库存"><br>ticket表示抽奖券数量。<br><img src="5.jpg" alt="抽奖券数量"><br>当页查找ticket，发现有一个initialize方法进行初始化。我们将此处的数量改为1000.<br><img src="6.jpg" alt="初始化方法"><br>快捷键Ctrl+E编辑IL指令。找到ticket变量后，将ldc.i4.0改为ldc.i4，然后将数值改为1000.<br><img src="7.jpg" alt="编辑IL指令"><br>确定后，发现ticket数值已经改变。<br><img src="8.jpg" alt="抽奖券修改"><br>重新打包APP后，进行安装。<br><img src="9.png" alt="抽奖券改变"><br>打开抽奖界面发现数量已经改变为1000。<br><img src="10.png" alt="抽奖后抽奖券变动"><br>这样虽然达到了修改抽奖券的效果，但数量再大，总会被抽完的。那就换种方法，比如说抽奖的时候增加奖券，或者奖券一直不变。这里采用奖券数量固定的方法，使其不会变动。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (SuperGameMaster.TicketStock() &lt; <span class="number">5</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ConfilmPanel confilm = <span class="keyword">this</span>.ConfilmUI.GetComponent&lt;ConfilmPanel&gt;();</span><br><span class="line">    confilm.OpenPanel(<span class="string">"ふくびき券が足りません"</span>);</span><br><span class="line">    confilm.ResetOnClick_Screen();</span><br><span class="line">    confilm.SetOnClick_Screen(delegate</span><br><span class="line">    &#123;</span><br><span class="line">        confilm.ClosePanel();</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>已知抽奖的时候奖券是从SuperGameMaster.TicketStock()获取的，找到该方法。令其返回值为固定的数值。<br><img src="11.jpg" alt="TicketStock方法"><br>右键编辑IL指令。<br><img src="12.jpg" alt="编辑IL指令"><br>将其值修改为9000.<br><img src="13.jpg" alt="修改返回值"><br>然后保存后打包并重新安装。<br><img src="14.png" alt="打包安装"><br>此时无论抽多少次，奖券都不再变化。<br>另一个就是修改三叶草的数量了。三叶草是该游戏中流行的货币，买东西都是需要该物品。同理找到CloverPointStock()方法。<br><img src="15.jpg" alt="修改三叶草"><br>将其返回值修改为8888。之后就可以随便买买买了，三叶草的数量也不会发生变化了。<br><img src="16.png" alt="三叶草数量"></p>
<h3 id="0x03-汉化"><a href="#0x03-汉化" class="headerlink" title="0x03 汉化"></a>0x03 汉化</h3><p>然后就是进行汉化了。汉化的方法和上面的类似。首先搜索需要修改的文字。例如给小青蛙起名字的时候。直接进行字符串搜索。<br><img src="17.jpg" alt="查找文字"><br>然后修改为对应的中文就行了。<br><img src="18.jpg" alt="日文修改为对应的中文"><br>进入游戏查看。<br><img src="19.png" alt="文字替换成功"><br>修改其他处的文字也是这样操作即可。当然这种修改方法比较慢，还有另外一种，直接将他人汉化过的dll文件复制进来，可以快速达到汉化的目的，也没有广告的烦恼了。</p>
<h3 id="0x04-其他修改"><a href="#0x04-其他修改" class="headerlink" title="0x04 其他修改"></a>0x04 其他修改</h3><p>按照以上方法修改的时候，每次都需要重新玩，还要经过”新手教学阶段”。我们可以使用安卓的备份功能，进行备份。然后重新安装app后直接恢复备份即可。<br>首先需要在AndroidManifest.xml文件中增加<code>android:allowBackup=&quot;true&quot;</code>。<br><img src="20.jpg" alt="修改AndroidManifest.xml文件"><br>这样就可以使用备份命令了。<br>命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">adb backup -nosystem -noshared -noapk -f jp.co.hit_point.tabikaeru.ab jp.co.hit_point.tabikaeru</span><br><span class="line">//-nosystem表示不备份系统应用 -noshared表示不备份应用存储在SD中的数据 -noapk表示不备份应用APK安装包 -f 表示备份的.ab文件路径和文件名 最后是要备份应用的packageName</span><br></pre></td></tr></table></figure>


<p><img src="23.jpg" alt="备份和恢复"><br>手机备份操作界面：<br><img src="21.png" alt="备份数据"></p>
<p>恢复命令比较简单</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb restore jp.co.hit_point.tabikaeru.ab</span><br></pre></td></tr></table></figure>
<p>手机备份还原界面<br><img src="22.png" alt="恢复数据"></p>
<p>然后就可以进行进度的保存和恢复了。就省去了每次都要进行”新手教学”的烦恼。</p>
<h3 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h3><p>这个游戏修改起来比较简单，首先判断为该游戏为Unity3d。然后使用dnSpy来对Assembly-CSharp.dll文件进行修改。根据特定的字符串找到需要修改的位置，修改后进行打包签名后即可。<br><a href="https://fuping.site/files/jp.co.hit_point.tabikaeru.apk">原版APK</a><br><a href="https://fuping.site/files/tabikaeru.apk">修改后的APK</a>（修改了抽奖券、三叶草和部分汉化）</p>
<h3 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h3><p>[1]<a href="https://www.52pojie.cn/search.php?mod=forum&amp;searchid=23262&amp;orderby=lastpost&amp;ascdesc=desc&amp;searchsubmit=yes&amp;kw=unity3d" target="_blank" rel="noopener">https://www.52pojie.cn/search.php?mod=forum&amp;searchid=23262&amp;orderby=lastpost&amp;ascdesc=desc&amp;searchsubmit=yes&amp;kw=unity3d</a><br>[2] <a href="https://www.52pojie.cn/thread-647612-1-1.html" target="_blank" rel="noopener">https://www.52pojie.cn/thread-647612-1-1.html</a></p>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/Unity3d/">#Unity3d</a><a href="/tags/%E9%9D%92%E8%9B%99%E6%97%85%E8%A1%8C/">#青蛙旅行</a><a href="/tags/%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">#逆向分析</a></p></article></div><footer><div class="paginator"><a href="/2018/02/08/Free-PhpJiaMi-Decrypt/" class="prev">PREV</a><a href="/2018/01/03/How-To-Use-AndroTickler/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2020 <a href="https://fuping.site">浮萍</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-103156844-1",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>