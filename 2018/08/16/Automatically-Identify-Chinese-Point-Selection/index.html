<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 中文点选验证码自动识别 · 浮萍's Blog</title><meta name="description" content="中文点选验证码自动识别 - 浮萍"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fuping.site/atom.xml" title="浮萍's Blog"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="浮萍's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">所有文章</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/search" target="_self" class="nav-list-link search"><i class="fa fa-search" aria-hidden="true"></i></a></li></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">中文点选验证码自动识别</h1><div class="post-info">Aug 16, 2018<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/" class="post-category">#验证码识别</a></div><div class="post-content"><p>某次测试中遇到了汉字点选的验证码，看着很简单，尝试了一下发现有两种简单的识别方法，终于有空给重新整理一下，分享出来。</p>
<a id="more"></a>

<h2 id="0x01-验证码的获取"><a href="#0x01-验证码的获取" class="headerlink" title="0x01  验证码的获取"></a>0x01  验证码的获取</h2><p>首先获取验证码。由于网站比较特殊，就不以他们的为例，自己生成验证码吧。这个不是重点，这里直接贴代码了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createImage</span><span class="params">($word,$imagePath,$type,$imageName)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    $fontPath = <span class="string">'msyh.ttc'</span>;<span class="comment">//字体</span></span><br><span class="line">    $fontSize = <span class="number">20</span> * <span class="number">0.75</span>;</span><br><span class="line">    <span class="keyword">foreach</span> ($word <span class="keyword">as</span> $v ) &#123;</span><br><span class="line">        $fontarea  = imagettfbbox($fontSize, <span class="number">0</span>, $fontPath, $v);</span><br><span class="line">        $textWidth = $fontarea[<span class="number">2</span>] - $fontarea[<span class="number">0</span>];</span><br><span class="line">        $textHeight = $fontarea[<span class="number">1</span>] - $fontarea[<span class="number">7</span>];</span><br><span class="line">        $tmp[<span class="string">'text'</span>] = $v;</span><br><span class="line">        $tmp[<span class="string">'size'</span>] = $fontSize;</span><br><span class="line">        $tmp[<span class="string">'width'</span>] = $textWidth;</span><br><span class="line">        $tmp[<span class="string">'height'</span>] = $textHeight;</span><br><span class="line">        $textArr[] = $tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">list</span>($imageWidth, $imageHeight, $imageType) = getimagesize($imagePath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;count($textArr);$i++)&#123;</span><br><span class="line">        <span class="keyword">list</span>($x, $y) = randPosition($textArr, $imageWidth, $imageHeight, $textArr[$i][<span class="string">'width'</span>], $textArr[$i][<span class="string">'height'</span>],$i,$type);</span><br><span class="line">        $textArr[$i][<span class="string">'x'</span>] = $x;</span><br><span class="line">        $textArr[$i][<span class="string">'y'</span>] = $y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unset</span>($v);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建图片的实例</span></span><br><span class="line">    $image = imagecreatefromstring(file_get_contents($imagePath));</span><br><span class="line">    <span class="comment">//字体颜色</span></span><br><span class="line">    $color = imagecolorallocate($image, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//绘画文字</span></span><br><span class="line">    <span class="keyword">foreach</span>($textArr <span class="keyword">as</span> $v)&#123;</span><br><span class="line">        imagefttext($image, $v[<span class="string">'size'</span>], <span class="number">0</span>, $v[<span class="string">'x'</span>], $v[<span class="string">'y'</span>], $color, $fontPath, $v[<span class="string">'text'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(imagepng($image,$imageName))&#123;</span><br><span class="line">        <span class="keyword">echo</span> $imageName.<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randPosition</span><span class="params">($textArr, $imgW, $imgH, $fontW, $fontH,$i,$type)</span></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span> ($type) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">0</span>:<span class="comment">//生成mp</span></span><br><span class="line">			$x = rand($i*<span class="number">60</span>, ($i+<span class="number">1</span>)*<span class="number">60</span>-$fontW<span class="number">-3</span>);</span><br><span class="line">			$y = rand(<span class="number">40</span>,<span class="number">80</span>); </span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:<span class="comment">//生成ap</span></span><br><span class="line">			$x = ($i)*<span class="number">25</span>+<span class="number">5</span>;</span><br><span class="line">			$y = <span class="number">25</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    $return = <span class="keyword">array</span>($x, $y);</span><br><span class="line">    <span class="keyword">return</span> $return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ap_imagePath = <span class="string">'ap_bg.png'</span>;</span><br><span class="line">$mp_imagePath = <span class="string">'mp_bg.png'</span>;</span><br><span class="line">$ap_imageName = <span class="string">"ap_"</span>.time().<span class="string">".png"</span>;</span><br><span class="line">$mp_imageName = <span class="string">"mp_"</span>.time().<span class="string">".png"</span>;</span><br><span class="line">$ap_word = <span class="keyword">array</span>(<span class="string">'请'</span>,<span class="string">'依'</span>,<span class="string">'次'</span>,<span class="string">'点'</span>,<span class="string">'击'</span>,<span class="string">'图'</span>,<span class="string">'中'</span>,<span class="string">'的'</span>,<span class="string">'猎'</span>, <span class="string">'户'</span>,<span class="string">'室'</span>) ;</span><br><span class="line">$mp_word = <span class="keyword">array</span>(<span class="string">'猎'</span>, <span class="string">'户'</span>, <span class="string">'实'</span>,<span class="string">'验'</span>,<span class="string">'室'</span>);</span><br><span class="line">createImage($ap_word,$ap_imagePath,<span class="number">1</span>,$ap_imageName);</span><br><span class="line">createImage($mp_word,$mp_imagePath,<span class="number">0</span>,$mp_imageName);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行后生成这样两张图片。</p>
<p>ap_XXXXX.png</p>
<p><img src="ap-01.png" alt="1534127745391"></p>
<p>mp_XXXXX.png</p>
<p><img src="mp-01.png" alt="1534127785857"></p>
<p>ap_XXXXX.png是说明需要点击的文字，mp_XXXXX.png是需要点击的图片。</p>
<h2 id="0x02-验证码识别"><a href="#0x02-验证码识别" class="headerlink" title="0x02  验证码识别"></a>0x02  验证码识别</h2><p>对于这种简单的点选验证码，可以有两种很容易的识别方式（机器学习算麻烦的，这里就不列出了。嗯，对，我也不会）。一种是opencv的图像模板匹配，另外一种是OCR识别。</p>
<h3 id="1-opencv的图像模板匹配"><a href="#1-opencv的图像模板匹配" class="headerlink" title="1. opencv的图像模板匹配"></a>1. opencv的图像模板匹配</h3><p>第一种方式，使用opencv的图像模板匹配。模板匹配是一种在较大图像中搜索和查找模板图像位置的方法，opencv2和opencv3中提供了一个专门用于模板匹配的函数matchTemplate()。它是在输入图像上滑动模板图像（如在2D卷积中），并比较模板图像下的输入图像的模板和补丁。在OpenCV中实现了六种比较方法（这里用到的是<code>cv2.TM_CCOEFF_NORMED</code>），它返回一个灰度图像，其中每个像素表示该像素的邻域与模板匹配的程度。</p>
<p>获得结果后，可以使用cv.minMaxLoc（）函数查找最大/最小值的位置。将其作为矩形的左上角，并将（w，h）作为矩形的宽度和高度，那个矩形就是模板区域。 。</p>
<p>我们进行使用模板匹配来识别这种验证码时，首先先将“模板”找出来，这里我们需要匹配的是“猎”、“户”、“室”这三个字。将这三个字所在的图片进行截取，然后使用matchTemplate()函数在mp中进行匹配。</p>
<p>首先截取第一个字“猎”。</p>
<p><img src="1534141199627.png" alt="1534141199627"></p>
<p>截取之后，就可以在mp中进行匹配。</p>
<p><img src="1534319979597.png" alt="1534319979597"></p>
<p>这里得到了最大和最小位置。我们使用最大位置，然后将最大值作为阈值。获取模板的尺寸，然后在mp中用矩形（红色区域）画出匹配的区域。如下所示。</p>
<p><img src="1534142377712.png" alt="1534142377712"></p>
<p>同理，用黄色和蓝色矩形将“户”、“室”所在的区域画出来。</p>
<p><img src="1534142664129.png" alt="1534142664129"></p>
<p>点选时发送所选区域中间的坐标即可，这里就不再给出实例了。</p>
<p>这种方法虽然简单，但是对于字体不一的就不能很正确的标记出来。</p>
<p>修改生成图片的代码，将mp中的文字的字体设置为随机。</p>
<p>修改的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> ($type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:<span class="comment">//mp 文字随机大小</span></span><br><span class="line">        $fontSize = rand(<span class="number">20</span>,<span class="number">30</span>) * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> <span class="number">1</span>:<span class="comment">//ap 文字固定</span></span><br><span class="line">        $fontSize = <span class="number">20</span> * <span class="number">0.75</span>;</span><br><span class="line">        <span class="keyword">break</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ap生成的结果还是和之前一样，mp的图片如下：</p>
<p><img src="1534406354140.png" alt="1534406354140"></p>
<p>使用同样的代码来匹配。</p>
<p><img src="1534406412351.png" alt="1534406412351"></p>
<p>此时匹配的结果就有些惨不忍睹了。所以就换另外一种识别方式-ocr识别。</p>
<h3 id="2-OCR识别"><a href="#2-OCR识别" class="headerlink" title="2. OCR识别"></a>2. OCR识别</h3><p>这里采用的是腾讯云的<a href="https://cloud.tencent.com/document/product/866/17600" target="_blank" rel="noopener">OCR-通用印刷体识别</a>。</p>
<p>参考文档。输入mp图片，返回的是json。</p>
<p><img src="1534407226287.png" alt="1534407226287"></p>
<p>查看json内容，发现包含了图片中的文字、位置和大小等。</p>
<p><img src="1534407260832.png" alt="1534407260832"></p>
<p>同理ap中内容也可以获取。</p>
<p><img src="1534407371139.png" alt="1534407371139"></p>
<p>此时匹配的时候直接就是匹配文字了。首先获取ap中后三个文字，然后与mp中返回的内容匹配，获取其位置和大小，然后再画矩形即可。</p>
<p>由于比较简单，这里直接贴结果。</p>
<p><img src="1534408948730.png" alt="1534408948730"></p>
<p>匹配相当完美。</p>
<h2 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03  总结"></a>0x03  总结</h2><p>本文用了两种方法来自动识别汉字点选验证码，第一种采用的是opencv的模板匹配，这种方法虽然也可以匹配到，但这种方法缺点就是对于字体形状差异较大的验证码识别率较低。而第二种方法就比较快捷方便了，而且识别度高，比较推荐第二种方法。</p>
<p>当然这两种方法对于简单、“正规”的验证码可以，遇到复杂的、“扭曲的”验证码就不行了。这时候就要用到机器学习了，而本文只是简单的“识别”，将机器学习用到这里，就有些大材小用了。</p>
<p>相关代码：<a href="https://github.com/fupinglee/MyPython/tree/master/captcha/Pointselection" target="_blank" rel="noopener">https://github.com/fupinglee/MyPython/tree/master/captcha/Pointselection</a></p>
<h2 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04  参考"></a>0x04  参考</h2><p>[1] <a href="http://bluewhale.cc/2017-09-22/use-python-opencv-for-image-template-matching-match-template.html" target="_blank" rel="noopener">http://bluewhale.cc/2017-09-22/use-python-opencv-for-image-template-matching-match-template.html</a></p>
<p>[2]<a href="https://cloud.tencent.com/document/product/866/17600" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/866/17600</a></p>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/%E7%82%B9%E9%80%89%E9%AA%8C%E8%AF%81%E7%A0%81/">#点选验证码</a><a href="/tags/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/">#验证码识别</a></p></article></div><footer><div class="paginator"><a href="/2018/11/19/QQ-Lock-bypass/" class="prev">PREV</a><a href="/2018/06/04/upload-labs-writeup/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2020 <a href="https://fuping.site">浮萍</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-103156844-1",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>