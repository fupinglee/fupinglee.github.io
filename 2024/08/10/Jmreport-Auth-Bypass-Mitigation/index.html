<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 积木报表授权绕过漏洞缓解措施 · 浮萍's Blog</title><meta name="description" content="积木报表授权绕过漏洞缓解措施 - 浮萍"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fuping.site/atom.xml" title="浮萍's Blog"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="浮萍's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">所有文章</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/search" target="_self" class="nav-list-link search"><i class="fa fa-search" aria-hidden="true"></i></a></li></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">积木报表授权绕过漏洞缓解措施</h1><div class="post-info">Aug 10, 2024<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/Exploit/" class="post-category">#Exploit</a></div><div class="post-content"><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>近期，积木报表被曝出存在一个授权绕过漏洞。该漏洞允许攻击者在请求中包含特定参数时绕过授权机制，从而访问诸如 save、queryFieldBySql、show 等接口。尽管之前的远程代码执行（RCE）漏洞已被修复，但攻击者仍能通过 AviatorScript 表达式注入，继续实现 RCE 攻击。</p>
<p>目前，积木报表的最新版本为 1.7.9，但测试发现，该版本仍存在授权绕过的风险。漏洞修复的版本暂未发布。为此，本文将提供一种有效的缓解措施，以帮助用户降低该漏洞带来的安全风险。</p>
<a id="more"></a>
<p><a name="apGSZ"></a></p>
<h2 id="0x01-漏洞复现"><a href="#0x01-漏洞复现" class="headerlink" title="0x01 漏洞复现"></a>0x01 漏洞复现</h2><p>至于漏洞分析这里就不进行了，有很多师傅已经发过详细的过程。这里使用的环境是<code>jeecg-boot 3.7.0</code>，积木报表版本为<code>1.7.9</code>。<br><img src="01.png" alt="image.png"><br>以接口 <code>jmreport/save</code>为例来判断漏洞是否存在。当没有<code>previousPage</code>和<code>jmLink</code>参数时，提示<code>Token</code>校验失败。<br><img src="02.png" alt="image.png"><br>增加<code>previousPage</code>和<code>jmLink</code>参数，且<code>jmLink</code>内容为类似 <code>aaa||bbb</code> 的base64 编码，可以保存成功，说明存在漏洞。<br><img src="03.png" alt="image.png"></p>
<p>访问<code>jmreport/queryFieldBySql</code>接口，可以绕过授权进行查询。<br><img src="04.png" alt="image.png"><br>但无法利用<code>CVE-2023-4450</code>漏洞。<br><img src="05.png" alt="image.png"></p>
<p>利用 <code>jmreport/save</code> 接口发送请求，写入构造好的<code>AviatorScript</code>表达式。</p>
<p><img src="06.png" alt="image.png"><br>访问<code>jmreport/show</code> 接口时触发。<br><img src="07.png" alt="image.png"><br>从上面的结果来看，在授权绕过的情况下，仍然可以RCE。接下来就是如何防止漏洞被利用。<br><a name="i3O6s"></a></p>
<h2 id="0x02-修复"><a href="#0x02-修复" class="headerlink" title="0x02 修复"></a>0x02 修复</h2><p>由于目前的最新版本依然存在漏洞，单纯升级并不能解决问题。如果应用系统不依赖积木报表，最简单直接的方法是删除积木报表。如果仍需使用该功能且不希望大幅修改代码，可以采取增加过滤器或使用 Nginx 代理等方式来防护。<br>以下是使用 Nginx 反向代理进行防护的示例。<br>根据漏洞的利用情况，可以设置当 URL 中同时包含参数 <code>previousPage</code> 和 <code>jmLink</code> 时，拦截请求并返回 403 错误。<br>以官方的docker为例，修改 <code>/etc/nginx/conf.d/default.conf</code>文件，增加如下代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化变量</span></span><br><span class="line"><span class="built_in">set</span> <span class="variable">$flag</span> <span class="string">""</span>;</span><br><span class="line"><span class="comment"># 如果存在 jmLink 参数</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~* <span class="string">"jmLink"</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>A"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 如果存在 previousPage 参数</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~* <span class="string">"previousPage"</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$flag</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>B"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 如果 flag 是 "AB"（即两个条件都满足），则返回 403</span></span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$flag</span> = AB ) &#123;</span><br><span class="line">     <span class="built_in">return</span> 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置完成后，重启Nginx。再次请求，返回403，说明配置生效。</p>
<p><img src="08.png" alt="image.png"><br>然而，当参数采用 URL 编码时，可以绕过上述限制。</p>
<p><img src="09.png" alt="image.png"></p>
<p>比较暴力的方法是当URL中含有<code>%</code> 时，返回403。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~* %) &#123;</span><br><span class="line">    <span class="built_in">return</span> 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置后重启Nginx，再次请求，成功拦截。<br><img src="10.png" alt="image.png"></p>
<p>另外，当 Nginx 安装了 <code>lua-nginx-module</code> 模块时，可以采用如下配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    lua_shared_dict my_cache 10m;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line"></span><br><span class="line">         location /jeecgboot &#123;</span><br><span class="line">            access_by_lua_block &#123;</span><br><span class="line">              </span><br><span class="line">                <span class="built_in">local</span> uri = ngx.unescape_uri(ngx.var.request_uri)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> string.match(uri, <span class="string">"jmLink"</span>) and</span><br><span class="line">                   string.match(uri, <span class="string">"previousPage"</span>)  <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">return</span> ngx.exit(ngx.HTTP_FORBIDDEN)</span><br><span class="line">                end</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            .....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过以上配置，也可以有效防止漏洞被利用，进一步保障系统安全。</p>
<p><a name="EtOSg"></a></p>
<h2 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h2><p>由于积木报表最新版本仍存在授权绕过漏洞，本文提供了一种简单的缓解措施。当然，防护的方法有很多种，例如直接使用 Web 应用防火墙（WAF）拦截恶意请求，或者在后端增加过滤器来加强安全性。通过这些措施，用户可以暂时降低系统受到攻击的风险，保障系统的稳定与安全。</p>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/jeecg-boot/">#jeecg-boot</a><a href="/tags/jmreport/">#jmreport</a><a href="/tags/%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D/">#漏洞修复</a></p></article></div><footer><div class="paginator"><a href="/2025/01/15/fakelocatioin-fix-journey/" class="prev">PREV</a><a href="/2023/11/23/ios-reverse-reactnative-case/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2025 <a href="https://fuping.site">浮萍</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-103156844-1",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>