<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CVE监控之Python代码实现 · 浮萍's Blog</title><meta name="description" content="CVE监控之Python代码实现 - 浮萍"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fuping.site/atom.xml" title="浮萍's Blog"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="浮萍's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">所有文章</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/search" target="_self" class="nav-list-link search"><i class="fa fa-search" aria-hidden="true"></i></a></li></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">CVE监控之Python代码实现</h1><div class="post-info">Dec 11, 2017<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BE%8E/" class="post-category">#编程之美</a></div><div class="post-content"><h1 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h1><p>前几天在先知上看到<a href="https://xianzhi.aliyun.com/forum/topic/1694/" target="_blank" rel="noopener">伪全栈式安全研发：CVE监控</a>这篇文章，就想着也实现一下代码进行最新CVE的监控。语言采用了Python，数据库也为Mongodb数据库。代码和实现的什么不重要，重要的是过程。</p>
<p>主要包括以下几个方面。</p>
<ol>
<li>获取最新的CVE列表和详情<br>主要采用了python的requests模块和BeautifulSoup模块。</li>
<li>将最新的CVE信息存入数据库<br>数据库使用了Mongodb，采用了pymongo模块。</li>
<li>通过邮件发送最新的CVE信息<br>发送邮件采用了smtplib模块。</li>
<li>定时执行任务<br>使用了linux的crontab来实现。</li>
</ol>
<a id="more"></a>
<h1 id="0x02-实现过程"><a href="#0x02-实现过程" class="headerlink" title="0x02 实现过程"></a>0x02 实现过程</h1><h2 id="1-获取最新的CVE列表和详情"><a href="#1-获取最新的CVE列表和详情" class="headerlink" title="1. 获取最新的CVE列表和详情"></a>1. 获取最新的CVE列表和详情</h2><p>访问<a href="https://cassandra.cerias.purdue.edu/CVE_changes/today.html" target="_blank" rel="noopener">https://cassandra.cerias.purdue.edu/CVE_changes/today.html</a> ，可以获取每天新增的CVE信息。</p>
<p><img src="%E6%8E%A5%E5%8F%A31.jpg" alt="接口1"></p>
<p><img src="%E6%8E%A5%E5%8F%A31%E6%BA%90%E4%BB%A3%E7%A0%81.jpg" alt="接口源代码"><br>通过查看源代码，发现没html没什么规律可言，都是些超链接。要想获取最新的列表，可以通过取文本中间的方法来获取。<br>这里需要获取<code>New entries:</code>和<code>Graduations</code>之间的内容。然后通过BeautifulSoup来解析其中的超链接。<br>主要代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getCVES</span><span class="params">()</span>:</span><span class="comment"># 获取最新到CVE列表</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        url = <span class="string">'https://cassandra.cerias.purdue.edu/CVE_changes/today.html'</span></span><br><span class="line">        res = requests.get(url, headers=headers, timeout=<span class="number">60</span>)</span><br><span class="line">        CVEList_html = getMiddleStr(res.text, <span class="string">'New entries:'</span>, <span class="string">'Graduations'</span>)</span><br><span class="line">        soup = BeautifulSoup(CVEList_html, <span class="string">'html.parser'</span>)</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> soup.find_all(<span class="string">'a'</span>):</span><br><span class="line">            print(a[<span class="string">'href'</span>])</span><br><span class="line">            print(a.string)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br></pre></td></tr></table></figure>
<p>获取文本中间内容的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getMiddleStr</span><span class="params">(content, startStr, endStr)</span>:</span> <span class="comment"># 获取文本中间内容</span></span><br><span class="line">    startIndex = content.index(startStr)</span><br><span class="line">    <span class="keyword">if</span> startIndex &gt;= <span class="number">0</span>:</span><br><span class="line">        startIndex += len(startStr)</span><br><span class="line">        endIndex = content.index(endStr)</span><br><span class="line">    <span class="keyword">return</span> content[startIndex:endIndex]</span><br></pre></td></tr></table></figure>

<p>运行效果：<br><img src="%E8%8E%B7%E5%8F%96CVE%E5%88%97%E8%A1%A8.jpg" alt="获取cve列表"><br>超链接的地址是CVE的详情。随便进入一个查看效果。<br>例如：<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-0874" target="_blank" rel="noopener">http://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-0874</a><br><img src="CVE%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF.jpg" alt="CVE详细信息"><br>这里需要记录的信息有：CVE-ID、Description、Assigning CNA和Date Entry Created。</p>
<p><img src="CVE%E8%AF%A6%E6%83%85%E7%BD%91%E9%A1%B5%E6%BA%90%E4%BB%A3%E7%A0%81.jpg" alt="CVE详情网页源代码"><br>通过查看网页源码发现，所有需要记录的信息在一个表格里面。但该页面有很多table，而且没有明显的标识来区分。而该table在div中，可以通过id来获取。<br>CVE-ID可以直接通过<code>soup.find(nowrap=&#39;nowrap&#39;).find(&#39;h2&#39;).string</code>获取。其他的几个信息可以通过获取相应tr中的td中的内容获得。<br><img src="%E8%8E%B7%E5%8F%96CVE%E8%AF%A6%E6%83%85.jpg" alt="获取CVE详情"><br>这样就可以获取最新的CVE列表和详情。</p>
<h2 id="2-将最新的CVE信息存入数据库"><a href="#2-将最新的CVE信息存入数据库" class="headerlink" title="2. 将最新的CVE信息存入数据库"></a>2. 将最新的CVE信息存入数据库</h2><p>数据库采用了Mongodb。安装方法<code>apt-get install mongodb</code><br>然后启动数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/data/ <span class="comment">#创建数据存储位置</span></span><br><span class="line">mongod --port 65521 --dbpath /var/data/ --bind_ip 127.0.0.1 <span class="comment">#启动mongodb，指定端口和路径，且仅本机可连</span></span><br><span class="line">mongo 127.0.0.1:65521/mydb </span><br><span class="line">db.createUser(&#123;user:<span class="string">'tass'</span>,<span class="built_in">pwd</span>:<span class="string">'liehu'</span>,roles:[&#123;role:<span class="string">'dbOwner'</span>,db:<span class="string">'mydb'</span>&#125;]&#125;) <span class="comment">#添加认证</span></span><br></pre></td></tr></table></figure>
<p>Mongodb数据库插入一条数据，一般使用的是insert。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.test.insert(&#123;<span class="string">"title"</span>:<span class="string">"test1"</span>, <span class="string">"blog_cont"</span>:<span class="string">"test1"</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>如果我们想实现一个如果title存在，就对数据进行更新，不存在，就插入。可以这样来实现。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.test.update(&#123;<span class="string">"title"</span>:<span class="string">"test2"</span>&#125;, &#123;<span class="variable">$set</span>:&#123;<span class="string">"title"</span>:<span class="string">"test2"</span>, <span class="string">"blog_cont"</span>:<span class="string">"test2"</span>&#125;&#125;, &#123;upsert:<span class="literal">true</span>&#125;)</span><br><span class="line">db.test.update(&#123;<span class="string">"title"</span>:<span class="string">"test1"</span>&#125;, &#123;<span class="variable">$set</span>:&#123;<span class="string">"title"</span>:<span class="string">"test1"</span>, <span class="string">"blog_cont"</span>:<span class="string">"test3"</span>&#125;&#125;, &#123;upsert:<span class="literal">true</span>&#125;)</span><br><span class="line">db.test.find()</span><br></pre></td></tr></table></figure>
<p>执行完成后最终有两条数据，title分别为test1和test2，对应的内容为test3和test2.</p>
<p><img src="insertOrUpdate.jpg" alt="存在更新，不存在插入"><br>因此在插入数据的时候，我们可以直接使用<code>db.test.update({&quot;title&quot;:&quot;test2&quot;}, {$set:{&quot;title&quot;:&quot;test2&quot;, &quot;blog_cont&quot;:&quot;test2&quot;}}, {upsert:true})</code>这种方式来实现。</p>
<p><img src="%E6%8F%92%E5%85%A5%E6%B5%8B%E8%AF%95.jpg" alt="插入测试"><br>更新只需更改data内容即可。<br><img src="%E6%9B%B4%E6%96%B0%E6%B5%8B%E8%AF%95.jpg" alt="更新测试"></p>
<blockquote>
<p>为了数据库的安全性，使用<code>--bind_ip 127.0.0.1</code>来设置数据库仅本地可以连接。更多mongodb数据库的配置可以参考<a href="http://blog.csdn.net/guoxingege/article/details/47339885" target="_blank" rel="noopener">MongoDB Mongodb.conf 配置 Auth</a>。</p>
</blockquote>
<h2 id="3-通过邮件发送最新的CVE信息"><a href="#3-通过邮件发送最新的CVE信息" class="headerlink" title="3. 通过邮件发送最新的CVE信息"></a>3. 通过邮件发送最新的CVE信息</h2><p>发送邮件这里用到了smtplib。<br>发送邮件比较简单，就直接贴代码了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendEmail</span><span class="params">(mail_msg)</span>:</span>  <span class="comment"># 发送邮件</span></span><br><span class="line">    sender = <span class="string">'from@163.com'</span> <span class="comment"># 发件人</span></span><br><span class="line">    password = <span class="string">'password'</span> <span class="comment"># 发件人密码</span></span><br><span class="line">    receiver = <span class="string">'receiver@163.com'</span> <span class="comment"># 收件人</span></span><br><span class="line">    message = MIMEText(mail_msg, <span class="string">'plain'</span>, <span class="string">'utf-8'</span>) <span class="comment">#以文本发送</span></span><br><span class="line">    message[<span class="string">'From'</span>] = sender</span><br><span class="line">    message[<span class="string">'To'</span>] = receiver</span><br><span class="line"></span><br><span class="line">    subject = <span class="string">'最新CVE列表'</span></span><br><span class="line">    message[<span class="string">'Subject'</span>] = Header(subject, <span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        smtpObj = smtplib.SMTP(<span class="string">'smtp.163.com'</span>)</span><br><span class="line">        smtpObj.login(sender, password)</span><br><span class="line">        smtpObj.sendmail(sender, receiver, message.as_string())</span><br><span class="line">        print(<span class="string">'邮件发送成功'</span>)</span><br><span class="line">    <span class="keyword">except</span> smtplib.SMTPException:</span><br><span class="line">        print(<span class="string">'Error: 无法发送邮件'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="4-定时执行任务"><a href="#4-定时执行任务" class="headerlink" title="4. 定时执行任务"></a>4. 定时执行任务</h2><p>直接使用linux下的crontab来完成。<br>例如设置每天早上7点执行，可以这样设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 7 * * * python /myJob/CVE-Monitor.py &gt;&gt; /<span class="built_in">log</span>/CVE-Monitor.log</span><br></pre></td></tr></table></figure>
<blockquote>
<p>根据<a href="https://cassandra.cerias.purdue.edu/CVE_changes/" target="_blank" rel="noopener">https://cassandra.cerias.purdue.edu/CVE_changes/</a> 看到today.html更新的时间是明天的06:53，对应北京时间是19:53。若想及时获取，可以更换时间为20:00.</p>
</blockquote>
<h2 id="5-完善和优化"><a href="#5-完善和优化" class="headerlink" title="5.完善和优化"></a>5.完善和优化</h2><p>到这里监控脚本完成的差不多了，剩下就是如何来融合一起并改善了。<br>为了方便发送邮件内容和插入数据库，我们新建类CVEInfo。主要代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CVEInfo</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,url, cveid, description, company, createdate)</span>:</span></span><br><span class="line">        self.url = url</span><br><span class="line">        self.cveid = cveid</span><br><span class="line">        self.description = description</span><br><span class="line">        self.company = company</span><br><span class="line">        self.createdate = createdate</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;p&gt;&lt;b&gt;漏洞编号：&lt;/b&gt;&lt;a href="'</span>+self.url+<span class="string">'"&gt;'</span>+self.cveid+<span class="string">'&lt;/a&gt;&lt;/p&gt;&lt;b&gt;相关厂商：&lt;/b&gt;'</span>\</span><br><span class="line">            +self.company +<span class="string">'&lt;br&gt;&lt;b&gt;披露日期：&lt;/b&gt;'</span>\</span><br><span class="line">            +self.createdate+<span class="string">'&lt;br&gt;&lt;b&gt;漏洞描述：&lt;/b&gt;'</span>\</span><br><span class="line">            +self.description + <span class="string">'&lt;br&gt;&lt;br&gt;&lt;hr/&gt;'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'cveid'</span>: self.cveid,</span><br><span class="line">            <span class="string">'description'</span>: self.description,</span><br><span class="line">            <span class="string">'company'</span>: self.company,</span><br><span class="line">            <span class="string">'createdate'</span>: datetime.strptime(self.createdate, <span class="string">"%Y%m%d"</span>),</span><br><span class="line">            <span class="string">'addDate'</span>: time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>, time.localtime(time.time())),</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<p>为了美观，将邮件以html方式发送</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">message = MIMEText(mail_msg, <span class="string">'html'</span>, <span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure>
<p>邮箱收到的效果：<br><img src="%E9%82%AE%E4%BB%B6%E5%86%85%E5%AE%B9.jpg" alt="邮件内容"><br>查看数据库数据：<br><img src="%E6%95%B0%E6%8D%AE%E5%BA%93%E5%86%85%E5%AE%B9.jpg" alt="数据库内容"></p>
<p>从上面两张图片可以看到有三十多个，但我们有时候并不是都需要看。我们可以根据Description中关键信息来进行过滤，仅仅将我们需要关注的CVE信息发送到邮箱或进行入库操作。<br>如下图为获取<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-8295" target="_blank" rel="noopener">CVE-2017-8295</a>的信息。<br><img src="%E6%B7%BB%E5%8A%A0%E5%85%B3%E9%94%AE%E5%AD%97%E5%8C%B9%E9%85%8D.jpg" alt="添加关键字匹配"><br>然后修改main方法，根据是否有关注的CVE信息来决定邮件的内容。<br>这里先用本地服务器为例，新建today.html文件，其中包含<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-9805" target="_blank" rel="noopener">CVE-2017-9805</a>和<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=2017-16241" target="_blank" rel="noopener">CVE-2017-16241</a>。<br><img src="%E5%85%B3%E9%94%AE%E5%AD%97%E5%8C%B9%E9%85%8D.jpg" alt="关键字匹配"><br>运行代码结果打印了一条包含了我们的关键字的数据。<br>邮件中的内容如下所示：<br><img src="%E5%85%B3%E9%94%AE%E5%AD%97%E5%8C%B9%E9%85%8D%E9%82%AE%E4%BB%B6%E5%86%85%E5%AE%B9.jpg" alt="关键字匹配邮件内容"><br>这样就能过滤其他CVE信息，仅仅记录我们关注的内容了。</p>
<h1 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h1><p>本文主要用到了BeautifulSoup解析网页和mongodb数据库的使用，然后就可以将想要的内容保存到数据库中。脚本并不限于在此处使用，也可以修改一下抓取其他网站内容。<br>代码地址：<a href="https://github.com/fupinglee/MyPython/blob/master/work/CVE-Monitor.py" target="_blank" rel="noopener">https://github.com/fupinglee/MyPython/blob/master/work/CVE-Monitor.py</a><br>查询的功能就不做了，若想实现其他功能，可以自行增加和修改。</p>
<h1 id="0x03-参考"><a href="#0x03-参考" class="headerlink" title="0x03 参考"></a>0x03 参考</h1><p>[1]<a href="https://xianzhi.aliyun.com/forum/topic/1694/" target="_blank" rel="noopener">https://xianzhi.aliyun.com/forum/topic/1694/</a><br>[2]<a href="http://blog.csdn.net/guoxingege/article/details/47339885" target="_blank" rel="noopener">http://blog.csdn.net/guoxingege/article/details/47339885</a></p>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/CVE-Monitor/">#CVE-Monitor</a><a href="/tags/Mongodb%E6%95%B0%E6%8D%AE%E5%BA%93/">#Mongodb数据库</a><a href="/tags/Python/">#Python</a></p></article></div><footer><div class="paginator"><a href="/2018/01/03/How-To-Use-AndroTickler/" class="prev">上一篇</a><a href="/2017/09/14/CVE-2017-8759-Remote-Code-Execution-Vulnerability-Replication/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 - 2020 <a href="https://fuping.site">浮萍</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-103156844-1",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>