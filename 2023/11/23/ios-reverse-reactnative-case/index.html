<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ios_reverse_reactnative_case · 浮萍's Blog</title><meta name="description" content="ios_reverse_reactnative_case - 浮萍"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fuping.site/atom.xml" title="浮萍's Blog"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="浮萍's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">所有文章</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/search" target="_self" class="nav-list-link search"><i class="fa fa-search" aria-hidden="true"></i></a></li></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">ios_reverse_reactnative_case</h1><div class="post-info">Nov 23, 2023<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/IOS%E9%80%86%E5%90%91/" class="post-category">#IOS逆向</a></div><div class="post-content"><p><a name="womOQ"></a></p>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>一个用<code>React Native</code>构建的IOS应用案例，需要获取密码的加密算法。</p>
<a id="more"></a>
<p><a name="jOsMy"></a></p>
<h2 id="0x01-过程"><a href="#0x01-过程" class="headerlink" title="0x01 过程"></a>0x01 过程</h2><p>登录抓包，发现密码被加密<br><img src="image01.png" alt="01.png"><br>然后对APP进行砸壳<br><img src="image02.png" alt="02.png"></p>
<p>发现了文件<code>main.jsbundle</code>，这个通常是由 <code>React Native</code>框架生成的。<code>React Native</code>是一个流行的跨平台移动应用开发框架，它允许开发者使用<code>JavaScript</code> 和 <code>React</code> 来构建应用。<br>使用 <code>React Native</code> 打包的应用，应用的一部分或全部界面和逻辑是用 <code>JavaScript</code> 实现的，而<code>JavaScript</code> 代码和资源会被打包成 <code>main.jsbundle</code> 文件。所以我们可以分析<code>main.jsbundle</code> 文件，将其重命名为<code>js</code>后缀，然后打开并格式化。</p>
<p>这里要寻找密码的加密方式，所以搜索<code>password:</code>，经过筛选后定位到下图代码<br><img src="image03.png" alt="03.png"><br>主要代码</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> e = c.state, t = e.username, n = e.password, l = e.deviceId, o = (<span class="number">0</span>, r(d[<span class="number">21</span>]).uuid)(<span class="number">16</span>),</span><br><span class="line">s = r(d[<span class="number">22</span>]).SecurityTools.AES_createKey(), u = &#123;</span><br><span class="line">  username: t,</span><br><span class="line">  password: (<span class="number">0</span>, r(d[<span class="number">23</span>]).btoa)(o) + <span class="string">"."</span> + (<span class="number">0</span>, r(d[<span class="number">24</span>]).encrypt)(n, o),</span><br><span class="line">  rememberMe: !<span class="number">1</span>,</span><br><span class="line">  language: <span class="string">'zhCN'</span>,</span><br><span class="line">  requestFrom: <span class="string">'app'</span>,</span><br><span class="line">  _KEY_: s,</span><br><span class="line">  ClientFlag: <span class="string">'PWdCipher'</span>,</span><br><span class="line">  deviceId: l</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>password的话由两部分组成，然后用”.”拼接了起来。<br>js中<code>(0,函数名)(参数)</code>就相当于函数的调用，如<br><img src="image04.png" alt="04.png"></p>
<p>所以password这里可以看作为</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r(d[<span class="number">23</span>]).btoa(o) + <span class="string">"."</span> +  r(d[<span class="number">24</span>]).encrypt(n, o)</span><br></pre></td></tr></table></figure>
<p><code>o</code>是由<code>(0, r(d[21]).uuid)(16)</code>获取的，<code>uuid</code> 通常是一个用于生成唯一标识符（UUID）的函数。在这里可能是用来生成一个特定长度为16位的UUID。<br><code>btoa</code> 是一个内置的 JavaScript 函数，通常用于Base64 编码。在这里，<code>r(d[23]).btoa</code>可能是对 btoa 函数的引用。因此判断前半部分的话应该是对<code>o</code>进行了base64编码。<br>根据抓包的结果，password前半部分为<code>V2FQRTlMbU5PejBwc0VsSw==</code>，对其进行base64解码，结果为<code>WaPE9LmNOz0psElK</code>，刚好是16位长度。这里的<code>o</code>对应的内容为<code>WaPE9LmNOz0psElK</code> 。<br>后半部分采用了<code>encrypt</code>加密，有2个参数n和o，n为输入的密码（测试的时候输入的是1），当前情况下<code>o</code>为<code>WaPE9LmNOz0psElK</code> 。<br>我们搜索<code>encrypt = function \(\w+, \w+\)</code><br>只有一个结果<br><img src="image05.png" alt="05.png"><br>采用了AES-CBC加密，参数<code>f</code>为输入的密码，c为16位的随机数（当前情况下c为<code>WaPE9LmNOz0psElK</code>）<br>接下来就是确定<code>n.default.secretKey</code>的值了。这个应用比较简单，直接查找使用就能找到值。<br><img src="image06.png" alt="06.png"><br>成功解密。<br><img src="image07.png" alt="07.png"></p>
<p>这是比较顺利的情况，可以直接找到<code>secretKey</code>。如果无法直接找到的话，可以通过插桩的方法来输出<code>secretKey</code>的值。将修改后的文件与<code>main.jsbundle</code>替换，然后重新打包ipa文件，也可以通过直接ssh连接到手机，直接替换<code>main.jsbundle</code>。第一种方法比较麻烦一点，一般都采用第二种。<br>ssh连接手机，执行命令<code>find / -name &quot;main.jsbundle&quot;</code>来搜索<code>main.jsbundle</code>文件。<br><img src="image08.png" alt="08.png"><br>红框中打码的内容为xxxx_app，与ipa解压payload中的一样，所以是这个。<br>然后通过<code>scp</code>将本地修改好的文件上传到手机上，替换<code>main.jsbundle</code>，重新运行app即可。<br>插桩的方法也有多种，如可以使用<code>console.log</code>或者<code>alert</code>输出。<br><img src="image09.png" alt="09.png"><br>运行效果<br><img src="image10.png" alt="10.png"></p>
<p>也可以设置一个全局变量（tempSecretKey），然后将<code>secretKey</code>的值赋给全局变量，然后放在数据包请求中。</p>
<p><img src="image11.png" alt="11.png"><br><img src="image12.png" alt="12.png"><br>运行APP后，进行抓包<br><img src="image13.png" alt="13.png"><br>也是可以成功获取secretKey的。<br><a name="wPZRP"></a></p>
<h2 id="0x02-总结"><a href="#0x02-总结" class="headerlink" title="0x02 总结"></a>0x02 总结</h2><p>对于<code>React Native</code>打包的APP，主要是分析<code>main.jsbundle</code>文件。通过插桩的方式来辅助分析，修改后替换手机上的文件。另外使用 <code>HBuilder</code> 开发的项目，做法类似，主要是分析和替换<code>app-service.js</code>文件 。</p>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/IOS%E9%80%86%E5%90%91/">#IOS逆向</a><a href="/tags/React-Native/">#React Native</a></p></article></div><footer><div class="paginator"><a href="/2023/11/08/vanished-login-page/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2023 <a href="https://fuping.site">浮萍</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-103156844-1",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>