<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ShiroExploit使用指南 · 浮萍's Blog</title><meta name="description" content="ShiroExploit使用指南 - 浮萍"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="search" type="application/opensearchdescription+xml" href="https://fuping.site/atom.xml" title="浮萍's Blog"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="浮萍's Blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">主页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">所有文章</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/search" target="_self" class="nav-list-link search"><i class="fa fa-search" aria-hidden="true"></i></a></li></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">ShiroExploit使用指南</h1><div class="post-info">Nov 27, 2020<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/%E7%BC%96%E7%A8%8B%E5%BC%80%E5%8F%91/" class="post-category">#编程开发</a></div><div class="post-content"><h2 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01 简介"></a>0x01 简介</h2><p>一款关于Shiro 1.2.4反序列化漏洞利用的回显工具。最新版本为v2.4。</p>
<a id="more"></a>

<blockquote>
<p>v2.4与v2.3相差不大，使用v2.3即可。</p>
<p>v2.3下载地址：<a href="https://github.com/fupinglee/JavaTools/blob/master/Shiro/ShiroExploit-v2.3.jar" target="_blank" rel="noopener">https://github.com/fupinglee/JavaTools/blob/master/Shiro/ShiroExploit-v2.3.jar</a><br>v2.3使用说明：<a href="https://github.com/fupinglee/JavaTools/blob/master/Shiro/%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E-v2.3.pdf" target="_blank" rel="noopener">https://github.com/fupinglee/JavaTools/blob/master/Shiro/%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E-v2.3.pdf</a></p>
</blockquote>
<p><strong>支持：</strong></p>
<p> 1.支持Tomcat7、Tomcat8、Tomcat9下的回显。</p>
<p> 2.支持Tomcat7、Tomcat8、Tomcat9下内存cmd马的写入与卸载。</p>
<p> 执行成功访问的URL为<a href="http://ip:port/xxx?labCmd=[命令]&amp;pwd=[密码]。">http://ip:port/xxx?labCmd=[命令]&amp;pwd=[密码]。</a></p>
<p> 3.支持Tomcat7、Tomcat8、Tomcat9下蚁剑内存shell的写入与卸载(请用蚁剑连接，连接类型CUSTOM)。 </p>
<p>执行成功后连接的URL为<a href="http://ip:port/xxx?ver=[任意字符串]。">http://ip:port/xxx?ver=[任意字符串]。</a></p>
<p> 4.支持Tomcat7、Tomcat8、Tomcat9下冰蝎内存shell的写入与卸载(请用蚁剑连接，连接类型JSP)。</p>
<p> 执行成功后连接的URL为<a href="http://ip:port/xxx。">http://ip:port/xxx。</a></p>
<p>5.新增配置中心，支持自定义UA和x-forwarded-for；新增内存代理Tunnel，新增AES-GCM加密方式的支持，新增一键卸载所有内存SHELL。</p>
<blockquote>
<p>以上发送请求时均需带上自定义的header：Accept-Header:[自定义的Accept-Header内容]</p>
</blockquote>
<p>下面具体说一下各个功能的使用方法，主要是介绍命令执行的使用方法。</p>
<h2 id="0x02-使用说明"><a href="#0x02-使用说明" class="headerlink" title="0x02 使用说明"></a>0x02 使用说明</h2><p>一共有三个功能模块，分别是KEY检测、命令执行和配置中心。</p>
<h3 id="KEY检测"><a href="#KEY检测" class="headerlink" title="KEY检测"></a>KEY检测</h3><p><img src="key%E6%A3%80%E6%B5%8B.png" alt="回显"></p>
<p>这一部分功能说明可以参考<a href="https://github.com/fupinglee/ShiroScan。" target="_blank" rel="noopener">https://github.com/fupinglee/ShiroScan。</a></p>
<p><strong>新增AES-GCM加密方式。</strong></p>
<h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><p>命令执行中一共有回显、内存shell和卸载这三块。</p>
<h4 id="回显"><a href="#回显" class="headerlink" title="回显"></a><strong>回显</strong></h4><p>输入正确的key，选择正确的Gadget即可。支持Tomcat6、7、8、9以及SpringBoot下的通用回显。</p>
<p><img src="01.png" alt="回显"></p>
<h4 id="内存shell"><a href="#内存shell" class="headerlink" title="内存shell"></a><strong>内存shell</strong></h4><p>这个一共有6个选择，分别是<strong>CMDSHELL</strong>、<strong>EvilObject</strong>、<strong>[蚁剑]蚁剑SHELL</strong>、<strong>[蚁剑]冰蝎SHELL</strong>、<strong>[蚁剑]冰蝎SHELL[SpringBoot]</strong>、<strong>Tunnel</strong>。</p>
<p>常用的有<strong>CMDSHELL</strong>、<strong>[蚁剑]蚁剑SHELL</strong>、<strong>[蚁剑]冰蝎SHELL</strong>、<strong>[蚁剑]冰蝎SHELL[SpringBoot]</strong>、<strong>Tunnel</strong> 5个，EvilObject在这里只是为了写入蚁剑SHELL和Tunnel而用的，暂时没有单独使用的机会，所以这里就不对其进行功能介绍了。</p>
<p><img src="25.png" alt="内存shell"></p>
<blockquote>
<p>内存Shell都是采用的Filter，因此连接或者使用时，可以使用任意路径，只需配置好指定的Header与密码。</p>
</blockquote>
<h5 id="1-CMDSHELL"><a href="#1-CMDSHELL" class="headerlink" title="1.CMDSHELL"></a>1.CMDSHELL</h5><p><img src="03.png" alt="CMDSHELL"></p>
<p>可以自定义密码和请求头，都是必须的。</p>
<p>保存完毕后点击开始按钮。</p>
<p><img src="04.png" alt="CMDshell"></p>
<p>执行的效果：</p>
<p><img src="05.png" alt="CMDshell"></p>
<p>只有在密码、和header都正确且存在的情况下，才会执行命令，否则返回正常的页面。</p>
<h5 id="2-蚁剑-蚁剑shell"><a href="#2-蚁剑-蚁剑shell" class="headerlink" title="2.[蚁剑]蚁剑shell"></a>2.[蚁剑]蚁剑shell</h5><p><img src="06.png" alt="蚁剑shell"></p>
<p>输入密码和Header保存后点击开始按钮，会将蚁剑Shell Filter加载进去</p>
<p><img src="07.png" alt="蚁剑shell"></p>
<p>使用蚁剑连接</p>
<p><img src="08.png" alt="蚁剑shell"></p>
<p>一共有三个需要注意的地方。</p>
<p>1.URL中需要有ver参数</p>
<p>2.连接类型为CUSTOM</p>
<p>3.需要添加Header，Name为Accept-Header，Value是自己设置的值</p>
<p>这三个都需要且正确，否则会连接不成功。</p>
<p><img src="09.png" alt="蚁剑shell"></p>
<h5 id="3-蚁剑-冰蝎shell"><a href="#3-蚁剑-冰蝎shell" class="headerlink" title="3.[蚁剑]冰蝎shell"></a>3.[蚁剑]冰蝎shell</h5><h6 id="a-Tomcat环境下"><a href="#a-Tomcat环境下" class="headerlink" title="a)Tomcat环境下"></a>a)Tomcat环境下</h6><p><img src="10.png" alt="冰蝎shell"></p>
<p>输入密码和Header保存后点击开始按钮，会将冰蝎Shell Filter加载进去</p>
<p><img src="11.png" alt="冰蝎shell"></p>
<p>这里的话需要使用新版的<strong>蚁剑</strong>来连接，冰蝎是无法连接此shell的，所以类型为<code>[蚁剑]冰蝎SHELL</code>。</p>
<p>不过最新版的蚁剑也是无法连接的，需要自己从<a href="https://github.com/AntSwordProject/antSword" target="_blank" rel="noopener">https://github.com/AntSwordProject/antSword</a> 下载代码，然后覆盖到自己的蚁剑目录才可以，作者已经更新了代码，但是还没有发布，需要自己下载后替换文件即可。</p>
<p><img src="12.png" alt="冰蝎shell"></p>
<p><img src="13.png" alt="冰蝎shell"></p>
<p>连接冰蝎shell也需要注意三点。</p>
<p>1.需要从github下载代码替换蚁剑客户端</p>
<p>2.连接类型为JSP</p>
<p>3.需要添加Header，Name为Accept-Header，Value是自己设置的值</p>
<p>否则也是无法连接的，这里就不演示了。</p>
<h6 id="b-SpringBoot环境下"><a href="#b-SpringBoot环境下" class="headerlink" title="b)SpringBoot环境下"></a>b)SpringBoot环境下</h6><p>支持回显与冰蝎shell</p>
<p><img src="20.png" alt="SpringBoot下回显"></p>
<p><img src="21.png" alt="Springboot下写入冰蝎内存shell"></p>
<p>连接时需要利用修改的蚁剑模版</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;fupinglee&#x2F;AntSword-JSP-Template</span><br><span class="line">cd AntSword-JSP-Template</span><br><span class="line">.&#x2F;build.sh</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://github.com/AntSwordProject/AntSword-JSP-Template/pull/1" target="_blank" rel="noopener">https://github.com/AntSwordProject/AntSword-JSP-Template/pull/1</a></p>
</blockquote>
<p>然后将dist下的文件替换</p>
<p><code>AntSwordData/antSword-master/source/core/jsp/template</code></p>
<p>中的文件，然后重启蚁剑客户端。</p>
<p>修改前连接500错误</p>
<p><img src="22.png" alt="Springboot下写入冰蝎内存shell"></p>
<p>修改后正常连接</p>
<p><img src="23.png" alt="Springboot下写入冰蝎内存shell"></p>
<p>蚁剑连接</p>
<p><img src="24.png" alt="Springboot下写入冰蝎内存shell"></p>
<h5 id="4-Tunnel"><a href="#4-Tunnel" class="headerlink" title="4.Tunnel"></a>4.Tunnel</h5><p>内存代理shell。</p>
<p><img src="26.png" alt="新增Tunnel内存代理"></p>
<p>这里就不需要密码了，因此密码框是无法编辑的。</p>
<p><img src="27.png" alt="新增Tunnel内存代理"></p>
<blockquote>
<p>注意这里是Cache-Header</p>
</blockquote>
<p><img src="28.png" alt="新增Tunnel内存代理"></p>
<p>使用原版的reGeorgSocksProxy.py是无法连接的。</p>
<p><img src="29.png" alt="Tunnel内存代理"></p>
<p>需要加上自定义的Cache-Header，这里是<code>&quot;Cache-Header&quot;:&quot;thisIsMyJob!@&quot;</code>。</p>
<p>也可以直接使用<a href="https://github.com/fupinglee/MyPython/blob/master/tools/reGeorgSocksProxy_MMShell.py" target="_blank" rel="noopener">https://github.com/fupinglee/MyPython/blob/master/tools/reGeorgSocksProxy_MMShell.py</a> </p>
<blockquote>
<p>注意使用时需要替换自己的Cache-Header的值。</p>
</blockquote>
<p>修改后运行</p>
<p><img src="30.png" alt="Tunnel内存代理"></p>
<h4 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h4><p>卸载的意思就是将Filter移除掉。</p>
<p>这里用cmdshell为例</p>
<p><img src="14.png" alt="卸载内存shell"></p>
<p>选择类型后确定，然后点击开始按钮</p>
<p><img src="15.png" alt="卸载内存shell"></p>
<p>cmdshell即被卸载</p>
<p><img src="16.png" alt="卸载内存shell"></p>
<p><strong>新增了一键卸载的命令。</strong></p>
<p><img src="31.png" alt="一键卸载内存shell"></p>
<p>会一次将所有写入的内存shell都给卸载。</p>
<h4 id="更新密码"><a href="#更新密码" class="headerlink" title="更新密码"></a>更新密码</h4><p>如何更新shell密码</p>
<p>仍以cmdshell为例，其他的一样的操作，都是重新加载一次内存shell即可。</p>
<p>首先加载一个cmdshell</p>
<p><img src="17.png" alt="修改密码"></p>
<p>修改密码是选择内存shell，然后选择shell类型，输入密码和自定义的header</p>
<p><img src="18.png" alt="修改密码"></p>
<p>修改密码为cmd2,原来的密码已经失效了</p>
<p><img src="19.png" alt="修改密码"></p>
<p>新的密码可以执行命令。</p>
<h3 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h3><p><img src="32.png" alt="配置中心"></p>
<p>配置中心可以使用代理和自定义UA、X-Forwarded-For，保存后立即生效。</p>
<blockquote>
<p>在两次实例中遇到了通过修改UA或X-Forwarded-For绕过限制执行命令的情况，因此增加了这个功能。</p>
</blockquote>
<h2 id="0x03-其他"><a href="#0x03-其他" class="headerlink" title="0x03 其他"></a>0x03 其他</h2><p><strong>仅供安全人员进行有授权的验证,勿用于非法测试。</strong></p>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%B7%A5%E5%85%B7/">#Shiro反序列化回显工具</a><a href="/tags/%E5%86%85%E5%AD%98shell/">#内存shell</a></p></article></div><footer><div class="paginator"><a href="/2020/12/16/IOS-APP-tomatodo-Cracked/" class="prev">PREV</a><a href="/2020/05/29/Test-Automation-Using-Appium/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2023 <a href="https://fuping.site">浮萍</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-103156844-1",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>